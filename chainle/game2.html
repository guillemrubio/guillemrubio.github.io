<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chainle: The Synonym Game 🔗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- Root Variables (Light Mode) --- */
    :root {
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --bg-color: #f0f4f8; /* Very light blue-gray */
      --text-color: #1e293b; /* Dark slate */
      --container-bg: #ffffff;
      --border-color: #cbd5e1;
      --primary-color: #4c51bf; /* Deep indigo */
      --secondary-color: #64748b; /* Medium gray-blue */
      --success-color: #10b981; /* Emerald green */
      --error-color: #ef4444; /* Bright red */
      --info-color: #3b82f6; /* Azure blue for feedback */
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --input-padding: 18px;
    }

    /* --- Dark Mode --- */
    body.dark-mode {
      --bg-color: #1f2937;
      --text-color: #f3f4f6;
      --container-bg: #374151;
      --border-color: #4b5563;
      --primary-color: #6366f1; /* Brighter indigo */
      --secondary-color: #9ca3af;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
      --hint-bg: #4c51bf;
      --hint-text: #e0e7ff;
    }

    /* --- Base Styling & Layout --- */
    body {
      font-family: var(--font-family);
      text-align: center;
      margin: 0;
      padding: 40px 15px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.4s, color 0.4s;
    }
    main {
      background-color: var(--container-bg);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 95%;
      max-width: 520px;
      margin: auto;
    }

    /* --- Header & Score (using <header> and <aside>) --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 15px;
      margin-bottom: 25px;
    }
    h1 {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary-color);
      letter-spacing: 0.5px;
      margin: 0;
    }
    aside.score-and-toggle {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .score {
      font-size: 20px;
      font-weight: 600;
      color: var(--secondary-color);
      transition: color 0.5s; /* Smooth score change */
    }
    .dark-mode-toggle {
      cursor: pointer;
      font-size: 24px;
    }

    /* --- Word Display (using <section>) --- */
    section.word-display {
      font-size: 44px;
      font-weight: 900;
      margin: 30px 0 20px;
      padding: 25px 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: var(--radius);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
    }
    .pos-tag {
      font-size: 18px;
      opacity: 0.8;
      margin-left: 10px;
      font-weight: 500;
      display: inline-block;
    }

    /* --- Input & Buttons --- */
    input {
      padding: var(--input-padding);
      width: 100%; 
      font-size: 18px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius);
      box-sizing: border-box;
      background-color: var(--container-bg);
      color: var(--text-color);
      margin-bottom: 10px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(76, 81, 191, 0.2);
      outline: none;
    }

    .button-group {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      padding: 14px 10px;
      font-size: 16px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
    }

    #submitButton {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 6px rgba(76, 81, 191, 0.3);
    }
    #submitButton:hover:not(:disabled) {
      background-color: #3f44a3;
      transform: translateY(-1px);
    }
    #shuffleButton, #endButton {
      background-color: var(--secondary-color);
      color: white;
      font-size: 14px;
    }
    #shuffleButton:hover:not(:disabled), #endButton:hover:not(:disabled) {
      background-color: #516075;
      transform: translateY(-1px);
    }
    #restartButton {
      background-color: var(--success-color);
      color: white;
      margin-top: 30px;
      padding: 15px;
      width: 100%;
      font-size: 18px;
    }
    button:disabled {
      background-color: var(--border-color) !important;
      color: #94a3b8 !important;
      cursor: not-allowed;
      box-shadow: none !important;
      transform: none !important;
    }

    /* --- Feedback & Messages --- */
    .message {
      padding: 15px;
      margin-top: 25px;
      font-weight: 600;
      border-radius: var(--radius);
      color: white;
      text-align: left;
      animation: fadeIn 0.3s ease-out;
    }
    .message.success {
      background-color: var(--success-color);
    }
    .message.error {
      background-color: var(--error-color);
    }
    .message.info {
      background-color: var(--info-color);
    }
    .hint {
      margin-top: 20px;
      padding: 18px;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-color);
      background-color: #fef3c7; /* Light yellow */
      border-radius: var(--radius);
      text-align: left;
      border-left: 5px solid #fbbf24; /* Amber border */
    }
    body.dark-mode .hint {
      background-color: var(--hint-bg, #4c51bf);
      color: var(--hint-text, #e0e7ff);
      border-left-color: #fcd34d;
    }

    /* --- Chain Display (using <section>) --- */
    section.chain-display {
      margin-top: 35px;
      font-size: 15px;
      color: var(--secondary-color);
      text-align: left;
      padding: 15px;
      background-color: var(--bg-color);
      border-radius: var(--radius);
      line-height: 1.8;
      border: 1px dashed var(--border-color);
      overflow-x: auto; 
      white-space: nowrap;
    }
    section.chain-display strong {
      color: var(--primary-color);
      display: block;
      margin-bottom: 5px;
      white-space: normal; 
    }
  </style>
</head>
<body>
  <main>
    
    <header>
      <h1>Chainle 🔗</h1>
      <aside class="score-and-toggle">
        <div class="score" id="score">Score: 0</div>
        <div class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeIcon">☀️</div>
      </aside>
    </header>
    
    <section class="word-display" id="currentWord">Loading Word...</section>

    <form onsubmit="event.preventDefault(); submitSynonym();">
      <input type="text" id="synonymInput" placeholder="Enter the next synonym" disabled autocomplete="off">
      
      <div class="button-group">
        <button type="submit" id="submitButton" disabled>SUBMIT SYNONYM</button>
        <button type="button" onclick="shuffleWord()" id="shuffleButton" style="display:none;">SKIP</button>
        <button type="button" onclick="endGame()" id="endButton" style="display:none;">END</button>
      </div>
    </form>
    
    <section class="feedback">
      <div class="message" id="message"></div>
      <div class="hint" id="hintBox" style="display:none;">💡</div>
    </section>
    
    <section class="chain-display" id="guessedWords">
      <strong>Full Chain:</strong> Start the chain!
    </section>

    <button type="button" onclick="startGame()" id="restartButton" style="display: none;">START NEW GAME</button>
  </main>

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>

  <script>
    let currentWord = "";
    let currentPOS = "";
    let score = 0;
    let usedWords = new Set();
    let chainWords = [];
    let allSynonyms = [];
    let guessCount = 0;
    let hintGiven = false;

    const synonymInput = document.getElementById("synonymInput");
    const messageElement = document.getElementById("message");
    const body = document.body;
    const darkModeIcon = document.getElementById("darkModeIcon");

    // Dark Mode Toggle Functionality
    function toggleDarkMode() {
      body.classList.toggle('dark-mode');
      const isDarkMode = body.classList.contains('dark-mode');
      darkModeIcon.textContent = isDarkMode ? '🌙' : '☀️';
      localStorage.setItem('darkMode', isDarkMode);
    }
    if (localStorage.getItem('darkMode') === 'true') {
      toggleDarkMode();
    } else {
      darkModeIcon.textContent = '☀️';
    }

    // Allows user to press Enter to submit via form submit event
    // No need for explicit keypress listener now due to the <form onsubmit> handler

    // Map POS tags to abbreviations
    function formatPOS(tags) {
      if (!tags) return "";
      if (tags.includes("n")) return "noun";
      if (tags.includes("v")) return "verb";
      if (tags.includes("adj")) return "adj";
      if (tags.includes("adv")) return "adv";
      return "";
    }

    // Fetch a random word with POS (DataMuse API)
    async function fetchRandomWord() {
      const alphabet = "abcdefghijklmnopqrstuvwxyz";
      const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
      const url = `https://api.datamuse.com/words?sp=${randomLetter}*&max=100&md=p`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const singleWords = data.filter(entry => !entry.word.includes(" "));
        if (singleWords.length > 0) {
          const randomIndex = Math.floor(Math.random() * singleWords.length);
          const entry = singleWords[randomIndex];
          return { word: entry.word, pos: formatPOS(entry.tags) };
        }
      } catch (error) {
        console.error("Error fetching random word:", error);
        return null;
      }
      return null;
    }

    // Fetch synonyms and related words for a given word (DataMuse API)
    async function fetchSynonyms(word) {
      const urls = [
        `https://api.datamuse.com/words?rel_syn=${word}&max=30&md=p`,
        `https://api.datamuse.com/words?ml=${word}&max=30&md=p`,
        `https://api.datamuse.com/words?rel_trg=${word}&max=30&md=p`,
      ];
      try {
        const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
        const process = (list) =>
          list
            .filter(entry => !entry.word.includes(" "))
            .map(entry => ({
              word: entry.word.toLowerCase(),
              pos: formatPOS(entry.tags)
            }));

        const merged = results.flatMap(process);
        const unique = [...new Map(merged.map(item => [item.word, item])).values()];
        return unique;
      } catch (error) {
        console.error("Error fetching synonyms:", error);
        return [];
      }
    }

    // Update game display
    function updateDisplay() {
      const wordDisplay = document.getElementById("currentWord");
      wordDisplay.innerHTML = `${currentWord.toUpperCase()} <span class="pos-tag">(${currentPOS})</span>`;
      document.getElementById("score").textContent = `Score: ${score}`;
      synonymInput.value = "";
      messageElement.textContent = "";
      messageElement.className = "message";
      
      // Show the entire chain history
      const displayWords = chainWords.length > 0 
        ? chainWords.join(" → ")
        : "Start the chain!";
      document.getElementById("guessedWords").innerHTML = `<strong>Full Chain:</strong> ${displayWords}`;

      synonymInput.focus();
    }

    // Check if word used
    function isWordUsed(word) {
      return usedWords.has(word.toLowerCase());
    }

    // Handle synonym submission
    async function submitSynonym() {
      const userInput = synonymInput.value.trim().toLowerCase();
      if (!userInput) {
        messageElement.textContent = "Please enter a word to submit.";
        messageElement.className = "message info";
        return;
      }
      
      const synonymEntry = allSynonyms.find(s => s.word === userInput);

      if (synonymEntry) {
        if (!isWordUsed(userInput)) {
          // CORRECT SCORING: 10 points (no hint) / 5 points (with hint)
          const points = hintGiven ? 5 : 10;
          score += points; 
          
          usedWords.add(userInput);
          chainWords.push(userInput);
          currentWord = userInput; 
          currentPOS = synonymEntry.pos;

          allSynonyms = await fetchSynonyms(currentWord);

          if (allSynonyms.length === 0) {
            messageElement.textContent = `🎉 Max Chain Reached! No more synonyms for "${currentWord.toUpperCase()}". Final Score: ${score}`;
            messageElement.className = "message success";
            endGame(true); 
            return;
          }

          updateDisplay();
          messageElement.textContent = `✅ Chain extended! +${points} points. Total Score: ${score}`;
          messageElement.className = "message success";
          guessCount = 0;
          document.getElementById("hintBox").style.display = "none";
          hintGiven = false;

        } else {
          // WORD USED
          messageElement.textContent = `🔄 "${userInput.toUpperCase()}" already in the chain. Try a different synonym.`;
          messageElement.className = "message info";
          synonymInput.value = "";
          synonymInput.focus();
        }
      } else {
        // INCORRECT WORD
        
        if (hintGiven) {
          messageElement.textContent = `❌ Game Over! Failed after hint. The chain ended at "${currentWord.toUpperCase()}".`;
          messageElement.className = "message error";
          endGame();
        } else {
          guessCount++;
          synonymInput.value = "";
          synonymInput.focus();
          
          const triesLeft = 3 - guessCount;
          messageElement.textContent = `❌ Incorrect. Tries left before hint: ${triesLeft}`;
          messageElement.className = "message error";
          
          if (guessCount >= 3) {
            document.getElementById("hintBox").style.display = "block";
            const availableSynonyms = allSynonyms.filter(s => !isWordUsed(s.word));
            const hints = availableSynonyms.slice(0, 3).map(s => `${s.word} (${s.pos})`);
            document.getElementById("hintBox").innerHTML = `💡 **Hint** (One try left, 5 points only): Try words like: *${hints.join(", ")}*`;
            hintGiven = true;
          }
        }
      }
    }

    // Shuffle to a new random word
    async function shuffleWord() {
      document.getElementById("currentWord").textContent = "FETCHING NEW WORD...";
      
      // Disable all buttons
      document.getElementById("submitButton").disabled = true;
      document.getElementById("shuffleButton").disabled = true;
      document.getElementById("endButton").disabled = true;

      let newEntry = null;
      let synonyms = [];
      do {
        newEntry = await fetchRandomWord();
        if (newEntry) {
          synonyms = await fetchSynonyms(newEntry.word);
        }
      } while (!newEntry || synonyms.length === 0);

      currentWord = newEntry.word;
      currentPOS = newEntry.pos;
      allSynonyms = synonyms;
      
      // Initialize the chain and used words set with the starting word
      usedWords.add(currentWord);
      chainWords.push(currentWord);

      updateDisplay();
      
      document.getElementById("hintBox").style.display = "none";
      messageElement.textContent = `New starting word: ${currentWord.toUpperCase()}. Extend the chain!`;
      messageElement.className = "message info";
      
      guessCount = 0;
      hintGiven = false;
      
      // Re-enable buttons
      document.getElementById("submitButton").disabled = false;
      document.getElementById("shuffleButton").disabled = false;
      document.getElementById("endButton").disabled = false;
    }

    // Start the game
    async function startGame() {
      // Reset state
      score = 0;
      chainWords = [];
      usedWords.clear();
      
      await shuffleWord();

      document.getElementById("endButton").style.display = "inline-block";
      document.getElementById("shuffleButton").style.display = "inline-block";
      document.getElementById("restartButton").style.display = "none";
      document.getElementById("synonymInput").disabled = false;
      document.getElementById("submitButton").disabled = false;
      
      synonymInput.focus();
    }

    // End the game
    function endGame(graceful = false) {
      if (!graceful) {
        messageElement.textContent = `🛑 CHAIN BROKEN. Your final score is ${score}.`;
        messageElement.className = "message error";
      }
      
      // Show the full chain in the final summary
      document.getElementById("guessedWords").innerHTML = `
        <strong>Final Chain Length:</strong> ${chainWords.length}<br>
        <strong>Full Chain:</strong> ${chainWords.join(" → ")}
      `;
          
      document.getElementById("endButton").style.display = "none";
      document.getElementById("shuffleButton").style.display = "none";
      document.getElementById("restartButton").style.display = "block";
      document.getElementById("synonymInput").disabled = true;
      document.getElementById("submitButton").disabled = true;
      document.getElementById("hintBox").style.display = "none";
    }

    // Start game on load
    startGame();
  </script>
</body>
</html>